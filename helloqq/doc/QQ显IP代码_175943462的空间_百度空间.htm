<html><head><title>QQ显IP代码_175943462的空间_百度空间</title><meta http-equiv=content-type content="text/html; charset=GBK"><link rel=alternate type="application/rss+xml" title="订阅该空间的博客文章" href="http://hi.baidu.com/175943462/rss"><style type="text/css">.error{color:#F00;font-size:12px}.shareUser,.shareLastEditor{line-height:20px;color:#666;text-align:left}.shareLastEditor{margin:5px 0 8px}</style><script>
	    var g_pageTimerStart=new Date().getTime();
	</script><script src="http://hi.bdimg.com/static/cblog/js/other/global.js?v=009301b8.js"></script><script src="http://hi.bdimg.com/static/cblog/js/other/libs.js?v=48b209f9.js"></script><script src="http://img.baidu.com/js/tangram-1.1.0.js?v=1334907755.js"></script><script>
var Session = {
    isLogin: !true,
    isHost: 0,
    loginStatus : 0,
    userName: "175943462",   
    userPortrait:'432e3137353934333436323204',
    spaceURL: "\/175943462",
    spBasicURL:"http:\/\/hi.baidu.com\/175943462",
    spBasicURLEnc:"http%3A%2F%2Fhi.baidu.com%2F175943462",
    visitorName:    "",
    visitorPortrait:'00000000',
    isActive: '0',   /*{cmt 访问者是否激活空间}*/
    visitorURL: "\/",        // 
    pageURL: "http://hi.baidu.com\/175943462\/blog\/item\/2b4d281a8026f4daaf513390.html",    
    refer: "http:\/\/www.google.com\/url?sa=t&rct=j&q=&esrc=s&source=web&cd=2&ved=0CFMQFjAB&url=http%3A%2F%2Fhi.baidu.com%2F175943462%2Fblog%2Fitem%2F2b4d281a8026f4daaf513390.html&ei=6p28T7jbH4iYiAfEnbDZDw&usg=AFQjCNF3gxEkHuVdHlRwbenK43_F-sVMIQ&sig2=hFMKI_JQbI65ANCRXIQi7Q",
    spToken: 'the fisrt two args should be string type:0,1!', 
    spFriendDomain: 'http://frd.baidu.com',
    spSpaceDomain: 'http://hi.baidu.com',
    spPortraitDomain: 'http://tx.bdimg.com',
    spSpaceStaticDomain: 'http://hi.bdimg.com', /*{cmt TODO RD似乎还不有提供这个变量，记得补成呀！}*/
    spImgDomain : 'http://img.baidu.com',
    spStaticDomain : 'http://hi.bdimg.com',

    isDrag: false  /*{cmt 是否在拖动页：是为了通用，只对模块内容有作用，这里也作为一个通用属性}*/
    ,isProfile: false   /*{cmt 是否在拖动页：是为了通用，只对模块内容有作用，这里也作为一个通用属性}*/
    ,isPortraitVerify:!true
    };
</script></head><body> <script>
/*<![CDATA[*/
if(top.location != self.location){
	top.location = self.location;
}
var myref = encodeURIComponent("http://hi.baidu.com\/175943462\/blog\/item\/2b4d281a8026f4daaf513390.html");
/*]]>*/
</script><!--[if (lt IE 8.0)]><link rel=stylesheet type=text/css href="http://hi.bdimg.com/static/cblog/css/ui/mods.css?v=774e31a7.css"><![endif]--><!--[if (!IE)|(gte IE 8.0)]><!--><link rel=stylesheet type=text/css href="http://hi.bdimg.com/static/cblog/css/ui/mods_datauri.css?v=a1661a70.css"><!--<![endif]--><link rel=stylesheet type=text/css href="http://hitn.bdimg.com/2402050202/css/item/c7591dec7d71b54f78f055de.css"><!--[if (lt IE 8.0)]><link rel=stylesheet type=text/css href="http://hi.bdimg.com/static/cblog/css/space.css?v=674c899c.css"><![endif]--><!--[if (!IE)|(gte IE 8.0)]><!--><link rel=stylesheet type=text/css href="http://hi.bdimg.com/static/cblog/css/space_datauri.css?v=b27686c7.css"><!--<![endif]--><div class=userbar><center> <div id=nav><a class=logo href=http://hi.baidu.com/index.htm><img src=http://img.baidu.com/hi/logo/logo_93_30.gif border=0 alt="百度空间"></a><div class="manage no-login"><form action="https://passport.baidu.com/?login" method=post>用户名:<input name=username>&nbsp;&nbsp; 密码:<input type=password name=password> <input type=hidden name=mem_pass value=on><input type=submit value="" style="width:0; height:0;"><a href="#" class=loginlink onclick="this.parentNode.submit(); return false;">登录</a> </form> <a href=/reg/new class=reglink>注册</a></div> </div></center></div><script src="http://hi.bdimg.com/static/base/js/conf/base.js?v=1334907755.js"></script><link rel=stylesheet type=text/css href="http://hi.bdimg.com/static/base/css/base.css?v=1334907755.css"><script language=javascript src="http://hi.bdimg.com/static/cblog/js/ui/dialog.js?v=f1d92f7b.js"></script><center><div id=main align=left><!--[if IE]><script>
var objmain = document.getElementById("main");
function updatesize(){ var bodyw = window.document.body.offsetWidth; if(bodyw <= 790) objmain.style.width="772px"; else if(bodyw >= 1016) objmain.style.width="996px"; else objmain.style.width="100%"; }
updatesize(); window.onresize = updatesize;
</script><![endif]--><div id=header><div class=lc><div class=rc></div></div><div class=tit><a href="/175943462" class=titlink title="175943462的空间 http://hi.baidu.com/175943462">175943462的空间</a></div><div class=desc>代码收集</div><div id=tabline>&nbsp;</div><div id=tab><a href="http://hi.baidu.com/175943462/home">主页</a><a href="http://hi.baidu.com/175943462/blog" class=on>博客</a><a href="http://hi.baidu.com/175943462/album">相册</a><span>|</span><a href="http://hi.baidu.com/175943462/profile">个人档案</a><span>|</span><a href="http://hi.baidu.com/175943462/friends">好友</a><span>|</span><a href="http://tieba.baidu.com/i/sys/jump?un=175943462&fr=spacebar" onclick="BdUtil.ns_trackerLink('m_20110330_spacebar','')" target=_blank>i贴吧</a></div></div><div class=stage><div class=stagepad><div style="width:100%"><table width="100%" border=0 cellspacing=0 cellpadding=0 class=modth><tr><td class=modtl width=7>&nbsp;<td class=modtc nowrap><div class=modhead><span class=modtit>查看文章</span></div><td class=modtc nowrap align=right><td class=modtr width=7>&nbsp;</table><div id=m_blog class=modbox style="overflow-x:hidden;"><div class=tit>QQ显IP代码</div><div class=date>2012-04-08 11:07</div><table style="table-layout:fixed;width:100%"><tr><td><div id=blog_text class=cnt><p><span><img src="http://hiphotos.baidu.com/175943462/pic/item/1480940f0cf3d7ca27eb7ed6f21fbe096a63a991.jpg" small="0" /></span><br /></p><p>// J8_QQ.cpp : Defines the entry point for the DLL application.<br />//</p><p>#include &quot;stdafx.h&quot;<br />#include &quot;resource.h&quot;<br />#include &quot;Hook/Hook.h&quot;</p><p>#include &lt;winsock2.h&gt;<br />#include &lt;afxinet.h&gt;<br />#include &lt;shlobj.h&gt; <br />#pragma comment(lib,&quot;ws2_32&quot;)<br />//使用CSTRING<br />#ifdef _DEBUG<br />#pragma comment(lib, &quot;libcmtd.lib&quot;)<br />#else<br />#pragma comment(lib, &quot;libcmt.lib&quot;)<br />#endif </p><p>#ifdef _X86_<br />extern &quot;C&quot; { int _afxForceUSRDLL; }<br />#else<br />extern &quot;C&quot; { int __afxForceUSRDLL; }<br />#endif</p><p>typedef int (__cdecl *MYOPENCONTACTCHATSESSION)(ULONG,struct ITXData *);<br />typedef int (__cdecl *MYGETCONTACTCHATSESSIONMAINHWND)(ULONG);<br />typedef int (__stdcall *MYSENDTO)(SOCKET,const char FAR *,int,int,const struct sockaddr FAR *,int);<br />typedef int (__cdecl *MYGETSTATUS)(ULONG);<br />typedef int (__cdecl *MYGETSELFUIN)(VOID);</p><p>// 聊天窗口写字<br />typedef int (__cdecl * CreateChatFrameType)(DWORD, unsigned long, DWORD *, DWORD);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //创建提示窗口<br />CreateChatFrameType CreateChatFrame = NULL;</p><p>typedef void (__cdecl * WriteMsgTipInChatSession)(DWORD, DWORD, const wchar_t *, DWORD);&nbsp;&nbsp;&nbsp; //写入提示<br />typedef void (__cdecl * WriteMsgTipInChatSession2)(DWORD, DWORD, DWORD, const wchar_t *, DWORD);&nbsp;&nbsp;&nbsp; //写入提示<br />WriteMsgTipInChatSession WriteMsgTip = NULL;<br />WriteMsgTipInChatSession2 WriteMsgTip2 = NULL;</p><p>typedef struct CTXBSTR<br />{<br />&nbsp;int zero;//貌似要一直是0<br />&nbsp;int count;//引用计数<br />&nbsp;int len1;<br />&nbsp;int len2;<br />&nbsp;wchar_t str[4100];<br />} TXStr, * pTXStr;</p><p>HMODULE hModule;<br />MYOPENCONTACTCHATSESSION OldOpenContactChatSession;<br />MYSENDTO Oldsendto;<br />MYGETSTATUS OldGetStatus;<br />TCHAR&nbsp;&nbsp; szPath[MAX_PATH];<br />TCHAR Onlineini[MAX_PATH];<br />TCHAR UACini[MAX_PATH];<br />TCHAR Cacheini[MAX_PATH];<br />BOOL bFlag = TRUE;</p><p>LRESULT CALLBACK DialogProc(HWND hWnd, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UINT Msg, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WPARAM wParam, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPARAM lParam)<br />{<br />&nbsp;<br />&nbsp;HWND hParent;<br />&nbsp;HDC hMdc;<br />&nbsp;HDC hDc;<br />&nbsp;switch(Msg)<br />&nbsp;{<br />&nbsp;case WM_SETFOCUS:<br />&nbsp;&nbsp;hParent = GetParent(hWnd);<br />&nbsp;&nbsp;SetFocus(hParent);<br />&nbsp;&nbsp;return 0;<br />&nbsp;&nbsp;<br />&nbsp;case WM_NCDESTROY:<br />&nbsp;&nbsp;hMdc = (HDC)GetProp(hWnd, &quot;MDC&quot;);<br />&nbsp;&nbsp;DeleteDC(hMdc);<br />&nbsp;&nbsp;return 0;<br />&nbsp;&nbsp;<br />&nbsp;case WM_INITDIALOG:<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;OutputDebugString(&quot;WM_INITDIALOG&quot;);<br />&nbsp;&nbsp;&nbsp;hParent = GetParent(hWnd);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;if ( !GetProp(hParent, &quot;GROUP&quot;) )<br />&nbsp;&nbsp;&nbsp;&nbsp;EndDialog(hWnd,0);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;DWORD dwStyle;<br />&nbsp;&nbsp;&nbsp;dwStyle = GetWindowLong(hWnd, GWL_EXSTYLE);<br />&nbsp;&nbsp;&nbsp;SetWindowLong(hWnd, GWL_EXSTYLE, <br />&nbsp;&nbsp;&nbsp;&nbsp;dwStyle | WS_EX_TOOLWINDOW | /*WS_EX_LAYERED*/ 0x00080000 | WS_EX_TRANSPARENT);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;ShowWindow(hWnd, SW_SHOW);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;hParent = GetParent(hWnd);<br />&nbsp;&nbsp;&nbsp;ULONG QQUIN = (ULONG)GetProp(hParent, &quot;QQUIN&quot;);<br />&nbsp;&nbsp;&nbsp;//BOOL v19 = GetIMVersion(hQQUIN)==0;<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;typedef unsigned short (__cdecl * MYGETIMVERSION) (ULONG);<br />&nbsp;&nbsp;&nbsp;unsigned short IMVersion = ((MYGETIMVERSION)GetProcAddress(LoadLibrary(&quot;KernelUtil&quot;), &quot;);<br />&nbsp;&nbsp;&nbsp;SetProp(hParent, &quot;SWITCH&quot;, (HANDLE)IMVersion);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;hDc = GetDC(hWnd);<br />&nbsp;&nbsp;&nbsp;hMdc = CreateCompatibleDC(hDc);<br />&nbsp;&nbsp;&nbsp;SetProp(hWnd, &quot;MDC&quot;, hMdc);<br />&nbsp;&nbsp;&nbsp;ReleaseDC(hWnd, hDc);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;SendMessage(hWnd, WM_TIMER, 4, 0);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;SetTimer(hWnd, 4, 1000, 0);<br />&nbsp;&nbsp;&nbsp;SetTimer(hWnd, 3, 30*1000, 0);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;//&nbsp;beginthread(fn401Message, 0, hWnd);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 401消息<br />&nbsp;&nbsp;&nbsp;//&nbsp;CreateThread(0, 0, (LPTHREAD_START_ROUTINE)MyTimerThread, hWnd, 0, 0);<br />&nbsp;&nbsp;&nbsp;hMdc = (HDC)GetProp(hWnd, &quot;MDC&quot;);<br />&nbsp;&nbsp;&nbsp;//WriteIPtoWnd( DT_SINGLELINE | DT_VCENTER, );<br />&nbsp;&nbsp;&nbsp;RECT rect;<br />&nbsp;&nbsp;&nbsp;//GetClientRect(hParent, &amp;rect);<br />&nbsp;&nbsp;&nbsp;rect.left=0i64;<br />&nbsp;&nbsp;&nbsp;rect.right=68719476956i64;<br />&nbsp;&nbsp;&nbsp;char tzTemp[MAX_PATH * 2];<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;DrawText(hMdc, TEXT(&quot;hello window&quot;), -1, &amp;rect, DT_SINGLELINE | DT_VCENTER | 0x8800);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;SetProp(hParent, &quot;ShowFade&quot;, (HANDLE)30);<br />&nbsp;&nbsp;&nbsp;POINT pptDst;<br />&nbsp;&nbsp;&nbsp;RECT Rect;<br />&nbsp;&nbsp;&nbsp;GetWindowRect(hParent, &amp;Rect);<br />&nbsp;&nbsp;&nbsp;pptDst.x = Rect.left + 12;<br />&nbsp;&nbsp;&nbsp;pptDst.y = Rect.bottom - 30;<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;SIZE psize;<br />&nbsp;&nbsp;&nbsp;psize.cx = 220;<br />&nbsp;&nbsp;&nbsp;psize.cy = 16;<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;POINT pptSrc;<br />&nbsp;&nbsp;&nbsp;pptSrc.x = 0;<br />&nbsp;&nbsp;&nbsp;pptSrc.y = 0;<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;BLENDFUNCTION pblend;<br />&nbsp;&nbsp;&nbsp;pblend.BlendOp = 0;<br />&nbsp;&nbsp;&nbsp;pblend.BlendFlags = 0;<br />&nbsp;&nbsp;&nbsp;pblend.AlphaFormat = 1;<br />&nbsp;&nbsp;&nbsp;pblend.SourceConstantAlpha = (UINT)GetProp(hParent, &quot;ShowFade&quot;);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;typedef BOOL (WINAPI *MYFUNC)(HWND,HDC,POINT*,SIZE*,HDC,POINT*,COLORREF,BLENDFUNCTION*,DWORD);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;MYFUNC UpdateLayeredWindow;<br />&nbsp;&nbsp;&nbsp;HINSTANCE hFuncInst ;<br />&nbsp;&nbsp;&nbsp;hFuncInst = LoadLibrary(&quot;User32.DLL&quot;); <br />&nbsp;&nbsp;&nbsp;BOOL bRet=FALSE;<br />&nbsp;&nbsp;&nbsp;if(hFuncInst) <br />&nbsp;&nbsp;&nbsp;&nbsp;UpdateLayeredWindow=(MYFUNC)GetProcAddress(hFuncInst, &quot;UpdateLayeredWindow&quot;);<br />&nbsp;&nbsp;&nbsp;UpdateLayeredWindow(hWnd, hDc, &amp;pptDst, &amp;psize, hMdc, &amp;pptSrc, 0, &amp;pblend, 2);<br />&nbsp;&nbsp;&nbsp;//ulw(m_hWnd,&nbsp;&nbsp; NULL,&nbsp;&nbsp; NULL,&nbsp;&nbsp; NULL,&nbsp;&nbsp; NULL,&nbsp;&nbsp; NULL,NULL,&nbsp;&nbsp; &amp;blend,&nbsp;&nbsp; 2); <br />&nbsp;&nbsp;&nbsp;wsprintf(tzTemp, &quot;hMdc:%d hWnd:%d hParent:%d rect.left:%d rect.right:%d UpdateLayeredWindow:%d&quot;,hMdc,hWnd,hParent, rect.left,rect.right,UpdateLayeredWindow);<br />&nbsp;&nbsp;&nbsp;OutputDebugString(tzTemp);<br />&nbsp;&nbsp;}<br />&nbsp;case WM_TIMER:<br />&nbsp;&nbsp;return 0;<br />&nbsp;}<br />&nbsp;<br />&nbsp;return 0;<br />}<br />short __cdecl sub_1000A49E(ULONG QQUIN)<br />{<br />&nbsp;HWND hChatMainWnd;<br />&nbsp;HWND hContactWindowHWnd;<br />&nbsp;void *Result;<br />&nbsp;MYGETCONTACTCHATSESSIONMAINHWND GetContactChatSessionMainHWndAddr;<br />&nbsp;GetContactChatSessionMainHWndAddr = (MYGETCONTACTCHATSESSIONMAINHWND)GetProcAddress(LoadLibrary(&quot;AppUtil.dll&quot;), <br />&nbsp;&nbsp;(LPCSTR)&quot;&quot;);<br />&nbsp;<br />&nbsp;hChatMainWnd=(HWND)GetContactChatSessionMainHWndAddr(QQUIN);<br />&nbsp;hContactWindowHWnd = hChatMainWnd;<br />&nbsp;Result=(void *)IsWindow(hChatMainWnd);<br />&nbsp;<br />&nbsp;if (Result)<br />&nbsp;{<br />&nbsp;&nbsp;Result =&nbsp; GetProp(hContactWindowHWnd, &quot;QQUIN&quot;);<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;if (!Result)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;HWND hWnd=CreateDialogParam(hModule,MAKEINTRESOURCE(IDD_DIALOG),hContactWindowHWnd,(DLGPROC)DialogProc, NULL);<br />&nbsp;&nbsp;&nbsp;SetProp(hContactWindowHWnd, &quot;LeftHwnd&quot;, hWnd);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;MSG msg;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;while(GetMessage(&amp;msg, NULL, 0, 0))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;TranslateMessage(&amp;msg);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;DispatchMessage(&amp;msg);&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;} <br />&nbsp;&nbsp;}<br />&nbsp;}<br />&nbsp;return (short)Result;<br />}</p><p>//写字符串到INI文件<br />BOOL WriteString(LPCTSTR section, LPCTSTR key, char *stringtoadd, char *filename)<br />{<br />&nbsp;&nbsp;&nbsp; CHAR FilePath[255]; <br />&nbsp;&nbsp;&nbsp; GetModuleFileName(NULL,FilePath,255); <br />&nbsp;&nbsp;&nbsp; (strrchr(FilePath,'\\'))[1] = 0; <br />&nbsp;&nbsp;&nbsp; strcat(FilePath,filename);<br />&nbsp;&nbsp;&nbsp; return WritePrivateProfileString(section,key,stringtoadd,FilePath);<br />} </p><p>//从INI文件中读取字符串<br />DWORD ReadString(char *section, char * key,&nbsp; char stringtoread[],&nbsp; char * filename)<br />{<br />&nbsp;&nbsp;&nbsp; CHAR FilePath[255]; <br />&nbsp;&nbsp;&nbsp; GetModuleFileName(NULL,FilePath,255); <br />&nbsp;&nbsp;&nbsp; (strrchr(FilePath,'\\'))[1] = 0; <br />&nbsp;&nbsp;&nbsp; strcat(FilePath,filename);<br />&nbsp;&nbsp;&nbsp; return GetPrivateProfileString(section, key,NULL,stringtoread,255,FilePath);<br />}</p><p>//获取状态<br />ULONG SelfQQUIN = 0;<br />USHORT __cdecl MyGetStatus(ULONG QQUIN)<br />{<br />&nbsp;USHORT uQQStatus = 0;<br />&nbsp;if(OldGetStatus) <br />&nbsp;&nbsp;uQQStatus = OldGetStatus(QQUIN);<br />/*<br />&nbsp;CHAR tzTemp[MAX_PATH];<br />&nbsp;wsprintf(tzTemp, &quot;QQ:%d的状态 %d&quot;,QQUIN,uQQStatus);<br />&nbsp;OutputDebugString(tzTemp);<br />*/<br />&nbsp;MYGETSELFUIN GetSelfUinAddr;&nbsp;<br />&nbsp;GetSelfUinAddr = (MYGETSELFUIN)GetProcAddress(LoadLibrary(&quot;KernelUtil.dll&quot;), <br />&nbsp;&nbsp;(LPCSTR)&quot;&quot;);<br />&nbsp;<br />&nbsp;if (QQUIN == GetSelfUinAddr() || QQUIN == SelfQQUIN)<br />&nbsp;{<br />&nbsp;&nbsp;return&nbsp; uQQStatus;<br />&nbsp;}<br />&nbsp;CHAR tzTemp[MAX_PATH];<br />&nbsp;int nChatMainWnd;</p><p>&nbsp;MYGETCONTACTCHATSESSIONMAINHWND GetContactChatSessionMainHWndAddr;<br />&nbsp;GetContactChatSessionMainHWndAddr = (MYGETCONTACTCHATSESSIONMAINHWND)GetProcAddress(LoadLibrary(&quot;AppUtil.dll&quot;), <br />&nbsp;&nbsp;(LPCSTR)&quot;&quot;);<br />&nbsp;<br />&nbsp;nChatMainWnd=(int)GetContactChatSessionMainHWndAddr(QQUIN);</p><p>&nbsp;if(uQQStatus == 10)<br />&nbsp;{<br />&nbsp;&nbsp;if (IsWindow((HWND)nChatMainWnd))<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;wsprintf(tzTemp, &quot;QQ:%d的状态 %d 对方在线&quot;,QQUIN,uQQStatus);<br />&nbsp;&nbsp;&nbsp;OutputDebugString(tzTemp);<br />&nbsp;&nbsp;}</p><p>&nbsp;}</p><p>&nbsp;if(uQQStatus == 20) //20是离线，10是在线 40是自己的在线状态<br />&nbsp;{<br />&nbsp;&nbsp;if (IsWindow((HWND)nChatMainWnd))<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;wsprintf(tzTemp, &quot;QQ:%d的状态 %d 对方不在线或隐身&quot;,QQUIN,uQQStatus);<br />&nbsp;&nbsp;OutputDebugString(tzTemp);<br />&nbsp;&nbsp;}</p><p>&nbsp;&nbsp;SelfQQUIN = QQUIN;&nbsp;&nbsp;<br />&nbsp;}<br />&nbsp;return uQQStatus;<br />}</p><p>void QQMsgInFrame(unsigned long QQUIN,wchar_t *lpText,int save)<br />{<br />&nbsp;MYGETCONTACTCHATSESSIONMAINHWND GetContactChatSessionMainHWndAddr;<br />&nbsp;<br />&nbsp;GetContactChatSessionMainHWndAddr = (MYGETCONTACTCHATSESSIONMAINHWND)GetProcAddress(LoadLibrary(&quot;AppUtil.dll&quot;), <br />&nbsp;&nbsp;(LPCSTR)&quot;&quot;);<br />&nbsp;<br />&nbsp;HWND hWnd = (HWND)GetContactChatSessionMainHWndAddr(QQUIN);<br />&nbsp;if(!IsWindow(hWnd) ) return;&nbsp;&nbsp;&nbsp; //避免无效窗口<br />&nbsp;char tzTemp1[MAX_PATH * 2];<br />&nbsp;wsprintfA(tzTemp1, &quot;%0x,%d&quot;,hWnd,QQUIN);<br />&nbsp;//OutputDebugStringA(tzTemp1);<br />&nbsp;TXStr MyMsg;<br />&nbsp;MyMsg.zero = 0;<br />&nbsp;MyMsg.count = 3;<br />&nbsp;wcsncpy(MyMsg.str, lpText,4096);<br />&nbsp;MyMsg.str[4096]=0;<br />&nbsp;MyMsg.len1 = MyMsg.len2 = wcslen(MyMsg.str) * sizeof(wchar_t);<br />&nbsp;<br />&nbsp;if(MyMsg.len1&lt;=0) return;//不显示空文本<br />&nbsp;<br />&nbsp;if(WriteMsgTip&amp;&amp;CreateChatFrame)<br />&nbsp;{<br />&nbsp;&nbsp;DWORD pointer = 0;//0x11111111;<br />&nbsp;&nbsp;CreateChatFrame(QQUIN, 0, &amp;pointer, 0);<br />&nbsp;&nbsp;WriteMsgTip(pointer, 0, MyMsg.str, 0);<br />&nbsp;}<br />&nbsp;else<br />&nbsp;{<br />&nbsp;&nbsp;if(WriteMsgTip2)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;WriteMsgTip2(QQUIN, 0, 0, MyMsg.str,0);<br />&nbsp;&nbsp;}<br />&nbsp;}<br />}</p><p>BOOL MByteToWChar(LPCSTR lpcszStr, LPWSTR lpwszStr, DWORD dwSize)&nbsp; <br />{ <br />&nbsp;DWORD dwMinSize;&nbsp;&nbsp;&nbsp; <br />&nbsp;dwMinSize = MultiByteToWideChar (CP_ACP, 0, lpcszStr, -1, NULL, 0);&nbsp;&nbsp;&nbsp; <br />&nbsp;if(dwSize &lt; dwMinSize)&nbsp;&nbsp; <br />&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp; return FALSE;&nbsp;&nbsp; <br />&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;MultiByteToWideChar (CP_ACP, 0, lpcszStr, -1, lpwszStr, dwMinSize);&nbsp;&nbsp;&nbsp; <br />&nbsp;return TRUE; <br />}</p><p>int __cdecl MyOpenContactChatSession(ULONG QQUIN,struct ITXData * xxx)<br />{<br />&nbsp;OutputDebugString(&quot;Entry MyOpenContactChatSession&quot;);<br />&nbsp;int nChatMainWnd;<br />&nbsp;short Result;</p><p>&nbsp;CHAR QQVersion[MAX_PATH];<br />&nbsp;CHAR QQVerTemp[MAX_PATH];</p><p>&nbsp;bFlag = TRUE;<br />&nbsp;MYGETCONTACTCHATSESSIONMAINHWND GetContactChatSessionMainHWndAddr;<br />&nbsp;<br />&nbsp;GetContactChatSessionMainHWndAddr = (MYGETCONTACTCHATSESSIONMAINHWND)GetProcAddress(LoadLibrary(&quot;AppUtil.dll&quot;), <br />&nbsp;&nbsp;(LPCSTR)&quot;&quot;);<br />&nbsp;<br />&nbsp;nChatMainWnd=(int)GetContactChatSessionMainHWndAddr(QQUIN);<br />&nbsp;<br />&nbsp;Result=(short)OldOpenContactChatSession;<br />&nbsp;<br />&nbsp;if (OldOpenContactChatSession)<br />&nbsp;&nbsp;Result=(short)OldOpenContactChatSession(QQUIN,xxx);<br />&nbsp;if (!nChatMainWnd)<br />&nbsp;{<br />&nbsp;&nbsp;//&nbsp;if (QQUIN&gt;10000)<br />&nbsp;&nbsp;//&nbsp;&nbsp;Result=sub_1000A49E(QQUIN);<br />&nbsp;}</p><p>&nbsp;if (20 == MyGetStatus(QQUIN))<br />&nbsp;{<br />&nbsp;&nbsp;OutputDebugString(&quot;对方不在线或隐身&quot;);<br />&nbsp;} <br />&nbsp;else<br />&nbsp;{<br />&nbsp;&nbsp;//取得对方QQ版本<br />&nbsp;&nbsp;typedef USHORT (__cdecl * MYGETIMVERSION) (ULONG);<br />&nbsp;&nbsp;USHORT uIMVersion = ((MYGETIMVERSION)GetProcAddress(LoadLibrary(&quot;KernelUtil&quot;),<br />&nbsp;&nbsp;&nbsp;&quot;);&nbsp;<br />&nbsp;&nbsp;USHORT QQVer = (uIMVersion&nbsp; % 100 | ((UCHAR)(uIMVersion / 100) &lt;&lt; 8));<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;//读取对应的QQ版本&nbsp;&nbsp;<br />&nbsp;&nbsp;wsprintf(QQVerTemp, &quot;%04X&quot;,QQVer);<br />&nbsp;&nbsp;GetPrivateProfileString(&quot;版本大全&quot;, QQVerTemp,NULL,QQVersion,255,&quot;.\\QQVersion.ini&quot;);<br />&nbsp;&nbsp;if (!QQVersion)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;wsprintf(QQVersion,&quot;未知版本0x%04X&quot;,QQVer);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;OutputDebugString(QQVersion);<br />&nbsp;}</p><p><br />&nbsp;if (bFlag)//bFlag的作用是只写入一次<br />&nbsp;{<br />&nbsp;&nbsp;CHAR QQIPInfo[MAX_PATH];<br />&nbsp;&nbsp;wchar_t wText[200];<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;CHAR QQNum[MAX_PATH];<br />&nbsp;&nbsp;DWORD dwReturnValue = 0; <br />&nbsp;&nbsp;CHAR TimeInFile[MAX_PATH];<br />&nbsp;&nbsp;wsprintf(QQNum, &quot;%d&quot;,QQUIN);<br />&nbsp;&nbsp;dwReturnValue = GetPrivateProfileString(&quot;TIME&quot;, QQNum, 0, TimeInFile, 255, Cacheini);<br />&nbsp;&nbsp;if (dwReturnValue)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;CHAR IPInFile[255];<br />&nbsp;&nbsp;&nbsp;CHAR LanIPInFile[255];<br />&nbsp;&nbsp;&nbsp;CHAR QQPosition[255];<br />&nbsp;&nbsp;&nbsp;GetPrivateProfileString(&quot;WAN&quot;, QQNum, 0, IPInFile, 255, Cacheini);<br />&nbsp;&nbsp;&nbsp;GetPrivateProfileString(&quot;LAN&quot;, QQNum, 0, LanIPInFile, 255, Cacheini);<br />&nbsp;&nbsp;&nbsp;GetPrivateProfileString(&quot;IP&quot;, IPInFile, 0, QQPosition, 255, Onlineini);<br />&nbsp;&nbsp;&nbsp;wsprintf(QQIPInfo, &quot;所在地:%s \n外网IP:%s \n内网IP:%s \nQQ版本:%s \n&quot;,QQPosition,IPInFile,LanIPInFile,QQVersion);<br />&nbsp;&nbsp;} <br />&nbsp;&nbsp;else<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;wsprintf(QQIPInfo, &quot;尚未探测IP地址,发送截图探测。\n对方QQ版本:%s&quot;,QQVersion);<br />&nbsp;&nbsp;}</p><p>&nbsp;&nbsp;MByteToWChar(QQIPInfo,wText,sizeof(wText)/sizeof(wText[0]));<br />&nbsp;&nbsp;QQMsgInFrame(QQUIN,wText,1);<br />&nbsp;}</p><p>&nbsp;return Result;<br />} </p><p>CString GetPosition( LPCTSTR lpIPAddr )<br />{<br />&nbsp;&nbsp;&nbsp; CInternetSession&nbsp;&nbsp;&nbsp; Session(&quot;J8_QQ&quot;,1,INTERNET_OPEN_TYPE_DIRECT);<br />&nbsp;&nbsp;&nbsp; CHttpFile&nbsp;&nbsp;&nbsp; *HttpFile=NULL;<br />&nbsp;&nbsp;&nbsp; CString&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strData;<br />&nbsp;&nbsp;&nbsp; CString&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strUrl; <br />&nbsp;&nbsp;&nbsp; CString&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strReturnStr=&quot;&quot;;<br />&nbsp;&nbsp;&nbsp; strUrl.Format( _T(&quot;<a href="http://www.ip138.com/ips.asp?ip=%s&amp;action=2">http://www.ip138.com/ips.asp?ip=%s&amp;action=2</a>&quot;), lpIPAddr );<br />&nbsp;&nbsp;&nbsp; HttpFile = (CHttpFile*)Session.OpenURL( strUrl );<br />&nbsp;&nbsp;&nbsp; while( HttpFile-&gt;ReadString( strData ) )<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strReturnStr += strData;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;<br />&nbsp;&nbsp;&nbsp; HttpFile-&gt;Close();<br />&nbsp;&nbsp;&nbsp; Session.Close();<br />&nbsp;<br />&nbsp;&nbsp;&nbsp; strReturnStr.Delete( 0, strReturnStr.Find( _T(&quot;本站主数据：&quot;) ) + 12 ); //再加上10个沉余字符<br />&nbsp;<br />&nbsp;&nbsp;&nbsp; int nPosLen = strReturnStr.Find( _T(&quot;参考数据&quot;) );<br />&nbsp;&nbsp;&nbsp; CString&nbsp;&nbsp;&nbsp; strPosition = strReturnStr.Left( nPosLen - 9 );&nbsp;&nbsp;&nbsp; //减去9个HTML沉余的字符<br />&nbsp;<br />&nbsp;strPosition.Replace(&quot; &quot;,NULL);//去掉空格<br />&nbsp;&nbsp;&nbsp; return strPosition;<br />}</p><p>CHAR QQLanIP[MAX_PATH];<br />int WINAPI Mysendto(SOCKET s, const char FAR * buf, int len,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int flags, const struct sockaddr FAR * to, int tolen)<br />{<br />&nbsp;ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QQUIN;<br />&nbsp;CHAR&nbsp;&nbsp;&nbsp; QQNum[MAX_PATH];<br />&nbsp;CHAR&nbsp;IPInFile[MAX_PATH];<br />&nbsp;CHAR LanIPInFile[MAX_PATH];<br />&nbsp;<br />&nbsp;//取得局域网IP地址<br />&nbsp;if(len !=27 || *buf !=3)<br />&nbsp;{<br />&nbsp;&nbsp;if(!*buf)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;if(len==1 || len ==84)<br />&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;strcpy(QQLanIP,inet_ntoa(((sockaddr_in *)to)-&gt;sin_addr));<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br />&nbsp;}</p><p>&nbsp;if(len==27 &amp;&amp; *buf == 3)<br />&nbsp;{<br />&nbsp;&nbsp;char *QQIP=inet_ntoa(((sockaddr_in *)to)-&gt;sin_addr);<br />&nbsp;&nbsp;//取得对方QQ号码<br />&nbsp;&nbsp;QQUIN = (UCHAR)buf[26] | (((UCHAR)buf[25] | (((UCHAR)buf[24] | ((UCHAR)buf[23] &lt;&lt; 8)) &lt;&lt; 8)) &lt;&lt; 8);<br />&nbsp;&nbsp;wsprintf(QQNum,&quot;%d&quot;,QQUIN);</p><p>&nbsp;&nbsp;//取得对方QQ版本<br />&nbsp;&nbsp;typedef USHORT (__cdecl * MYGETIMVERSION) (ULONG);<br />&nbsp;&nbsp;USHORT uIMVersion = ((MYGETIMVERSION)GetProcAddress(LoadLibrary(&quot;KernelUtil&quot;),<br />&nbsp;&nbsp;&nbsp;&quot;);&nbsp;<br />&nbsp;&nbsp;USHORT QQVer = (uIMVersion&nbsp; % 100 | ((UCHAR)(uIMVersion / 100) &lt;&lt; 8));<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;//读取对应的QQ版本<br />&nbsp;&nbsp;CHAR QQVersion[MAX_PATH];<br />&nbsp;&nbsp;CHAR QQVerTemp[MAX_PATH];&nbsp;&nbsp;<br />&nbsp;&nbsp;wsprintf(QQVerTemp, &quot;%04X&quot;,QQVer);<br />&nbsp;&nbsp;ReadString(&quot;版本大全&quot;, QQVerTemp, QQVersion, &quot;QQVersion.ini&quot;);<br />&nbsp;&nbsp;if (QQVersion)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;wsprintf(QQVerTemp,&quot;未知版本0x%04X&quot;,QQVer);<br />&nbsp;&nbsp;&nbsp;OutputDebugString(QQVerTemp);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;//对方地理位置<br />&nbsp;&nbsp;CString QQPositionTemp;<br />&nbsp;&nbsp;CHAR *QQPosition;<br />&nbsp;&nbsp;QQPositionTemp = GetPosition(QQIP);<br />&nbsp;&nbsp;QQPosition = QQPositionTemp.GetBuffer(QQPositionTemp.GetLength());<br />&nbsp;&nbsp;CHAR tzTemp[MAX_PATH];<br />&nbsp;&nbsp;wsprintf(tzTemp, &quot;IP地址:%s \n所在地:%s \nQQ号码:%d \nQQ版本:%s \nQQVer:%d&quot;,QQIP,QQPosition,QQUIN,QQVersion,QQVerTemp);<br />&nbsp;&nbsp;OutputDebugString(tzTemp);</p><p>&nbsp;&nbsp;//取得现在的时间<br />&nbsp;&nbsp;SYSTEMTIME LocalTime;<br />&nbsp;&nbsp;CHAR LocalTimeTemp[MAX_PATH];<br />&nbsp;&nbsp;GetLocalTime(&amp;LocalTime);<br />&nbsp;&nbsp;wsprintf(LocalTimeTemp,&quot;%04d%02d%02d&quot;,LocalTime.wYear,LocalTime.wMonth,LocalTime.wDay);<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;DWORD dwReturnValue = 0; <br />&nbsp;&nbsp;CHAR TimeInFile[MAX_PATH];<br />&nbsp;&nbsp;dwReturnValue = GetPrivateProfileString(&quot;TIME&quot;, QQNum, 0, TimeInFile, 255, Cacheini);<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;if (dwReturnValue)//读到时间<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;if (strcmp(LocalTimeTemp,TimeInFile))//时间不等<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;WritePrivateProfileString(&quot;TIME&quot;, QQNum, LocalTimeTemp, Cacheini);<br />&nbsp;&nbsp;&nbsp;&nbsp;WritePrivateProfileString(&quot;WAN&quot;, QQNum, QQIP, Cacheini);<br />&nbsp;&nbsp;&nbsp;&nbsp;WritePrivateProfileString(&quot;IP&quot;, QQIP, QQPosition, Onlineini);&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;GetPrivateProfileString(&quot;WAN&quot;, QQNum, 0, IPInFile, 255, Cacheini);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;if (strcmp(IPInFile,QQIP))//IP地址不等<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WritePrivateProfileString(&quot;WAN&quot;, QQNum, QQIP, Cacheini);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WritePrivateProfileString(&quot;IP&quot;, QQIP, QQPosition, Onlineini);<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;} <br />&nbsp;&nbsp;else<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;WritePrivateProfileString(&quot;TIME&quot;, QQNum, LocalTimeTemp, Cacheini);<br />&nbsp;&nbsp;&nbsp;WritePrivateProfileString(&quot;WAN&quot;, QQNum, QQIP, Cacheini);<br />&nbsp;&nbsp;&nbsp;WritePrivateProfileString(&quot;IP&quot;, QQIP, QQPosition, Onlineini);&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;if (QQLanIP)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;GetPrivateProfileString(&quot;LAN&quot;, QQNum, 0, LanIPInFile, 255, Cacheini);<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;if (strcmp(LanIPInFile,QQLanIP))//局域网IP地址不等<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;WritePrivateProfileString(&quot;LAN&quot;, QQNum, QQLanIP, Cacheini);<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;else<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;WritePrivateProfileString(&quot;LAN&quot;, QQNum, &quot;0:0:0:0&quot;, Cacheini);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;if (bFlag)//bFlag的作用是只写入一次<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;CHAR QQIPInfo[MAX_PATH];<br />&nbsp;&nbsp;&nbsp;wchar_t wText[200];<br />&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;GetPrivateProfileString(&quot;WAN&quot;, QQNum, 0, IPInFile, 255, Cacheini);<br />&nbsp;&nbsp;&nbsp;GetPrivateProfileString(&quot;LAN&quot;, QQNum, 0, LanIPInFile, 255, Cacheini);<br />&nbsp;&nbsp;&nbsp;GetPrivateProfileString(&quot;IP&quot;, QQIP, 0, QQPosition, 255, Onlineini);<br />&nbsp;&nbsp;&nbsp;wsprintf(QQIPInfo, &quot;所在地:%s \n外网IP:%s \n内网IP:%s \nQQ版本:%s \n&quot;,QQPosition,QQIP,LanIPInFile,QQVersion);<br />&nbsp;&nbsp;&nbsp;MByteToWChar(QQIPInfo,wText,sizeof(wText)/sizeof(wText[0]));<br />&nbsp;&nbsp;&nbsp;QQMsgInFrame(QQUIN,wText,1);<br />&nbsp;&nbsp;&nbsp;bFlag = FALSE;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<br />&nbsp;}</p><p>&nbsp;return Oldsendto(s, buf, len, flags, to, tolen);<br />}</p><p>LPVOID GetFunProc(LPCTSTR qqDllName,LPCSTR qqFunName)<br />{<br />&nbsp;HMODULE hMod = GetModuleHandle(qqDllName);<br />&nbsp;if(hMod == NULL)<br />&nbsp;{<br />&nbsp;&nbsp;TCHAR qqPath[MAX_PATH];<br />&nbsp;&nbsp;if(GetCurrentDirectory(MAX_PATH,qqPath)==0)<br />&nbsp;&nbsp;&nbsp;return NULL;<br />&nbsp;&nbsp;strcat(qqPath,qqDllName);<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;hMod = LoadLibrary(qqPath);<br />&nbsp;&nbsp;if(hMod==NULL)<br />&nbsp;&nbsp;&nbsp;return NULL;<br />&nbsp;}<br />&nbsp;return (LPVOID)GetProcAddress(hMod,qqFunName);<br />}</p><p>BOOL InitHook()<br />{<br />&nbsp;OutputDebugString(&quot;Entry InitHook()&quot;);&nbsp;<br />&nbsp;OldOpenContactChatSession=(MYOPENCONTACTCHATSESSION)HookFunction(&quot;AppUtil.dll&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(void *)MyOpenContactChatSession);<br />&nbsp;<br />&nbsp;Oldsendto=(MYSENDTO)HookFunction(&quot;ws2_32.dll&quot;,&quot;sendto&quot;,(void *)Mysendto);<br />/*<br />&nbsp;OldGetStatus=(MYGETSTATUS)HookFunction(&quot;KernelUtil.dll&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;(void *)MyGetStatus);</p><p>&nbsp;CHAR tzTemp[MAX_PATH];<br />&nbsp;wsprintf(tzTemp, &quot;OldGetStatus %d&quot;,OldGetStatus);<br />&nbsp;OutputDebugString(tzTemp);<br />*/<br />&nbsp;// 聊天窗口写字<br />&nbsp;CreateChatFrame = (CreateChatFrameType)GetFunProc(&quot;AppUtil.dll&quot;,&quot;&quot;);<br />&nbsp;WriteMsgTip = (WriteMsgTipInChatSession)GetFunProc(&quot;AppUtil.dll&quot;,&quot;&quot;);<br />&nbsp;if(!CreateChatFrame || !WriteMsgTip)<br />&nbsp;{<br />&nbsp;&nbsp;WriteMsgTip2 = (WriteMsgTipInChatSession2)GetFunProc(&quot;AppUtil.dll&quot;,&quot;&quot;);<br />&nbsp;}</p><p>&nbsp;return true;<br />}</p><p>BOOL UnHook()<br />{<br />&nbsp;OutputDebugString(&quot;Entry UnHook()&quot;);</p><p>&nbsp;UnHookFunction(&quot;AppUtil.dll&quot;,<br />&nbsp;&nbsp;&quot;&quot;,<br />&nbsp;&nbsp;(void *)OldOpenContactChatSession);</p><p>&nbsp;UnHookFunction(&quot;ws2_32.dll&quot;,&quot;sendto&quot;,(void *)Oldsendto);<br />&nbsp;//UnHookFunction(&quot;KernelUtil.dll&quot;,&quot; *)OldGetStatus);<br />&nbsp;return true;<br />&nbsp;<br />}</p><p>VOID CreateFiles()<br />{<br />&nbsp;<br />&nbsp;SHGetSpecialFolderPath(NULL,szPath,CSIDL_APPDATA,0);<br />&nbsp;strcat(szPath,&quot;&quot;);<br />&nbsp;<br />&nbsp;DWORD dwAttributes = GetFileAttributes(szPath);<br />&nbsp;if(!(dwAttributes &amp; FILE_ATTRIBUTE_DIRECTORY))<br />&nbsp;&nbsp;DeleteFile(szPath);<br />&nbsp;if(-1 == dwAttributes)<br />&nbsp;&nbsp;CreateDirectory(szPath,NULL);<br />&nbsp;<br />&nbsp;strcpy(Onlineini,szPath);<br />&nbsp;strcat(Onlineini,&quot;&quot;);<br />&nbsp;<br />&nbsp;strcpy(UACini,szPath);<br />&nbsp;strcat(UACini,&quot;&quot;);<br />&nbsp;<br />&nbsp;strcpy(Cacheini,szPath);<br />&nbsp;strcat(Cacheini,&quot;&quot;);<br />&nbsp;<br />&nbsp;//C:\Documents and Settings\Administrator\Application Data\JiaoBen<br />&nbsp;CreateFile(Onlineini,GENERIC_WRITE|GENERIC_READ,FILE_SHARE_WRITE|FILE_SHARE_READ,0,CREATE_NEW,FILE_ATTRIBUTE_NORMAL,0);<br />&nbsp;CreateFile(UACini,GENERIC_WRITE|GENERIC_READ,FILE_SHARE_WRITE|FILE_SHARE_READ,0,CREATE_NEW,FILE_ATTRIBUTE_NORMAL,0);<br />&nbsp;CreateFile(Cacheini,GENERIC_WRITE|GENERIC_READ,FILE_SHARE_WRITE|FILE_SHARE_READ,0,CREATE_NEW,FILE_ATTRIBUTE_NORMAL,0);<br />&nbsp;<br />&nbsp;OutputDebugStringA(szPath);<br />}</p><p>BOOL APIENTRY DllMain( HINSTANCE hinstDLL, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD&nbsp; ul_reason_for_call, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPVOID lpReserved<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br />{<br />&nbsp;hModule = hinstDLL;<br />&nbsp;<br />&nbsp;switch(ul_reason_for_call)<br />&nbsp;{<br />&nbsp;case DLL_PROCESS_ATTACH:<br />&nbsp;&nbsp;CreateFiles();<br />&nbsp;&nbsp;if (!InitHook())<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;MessageBox(NULL,&quot;InitHook() Error&quot;,&quot;ERROR&quot;,MB_OK);<br />&nbsp;&nbsp;&nbsp;return false;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;break;<br />&nbsp;case DLL_PROCESS_DETACH:<br />&nbsp;&nbsp;UnHook();<br />&nbsp;&nbsp;break;<br />&nbsp;case DLL_THREAD_ATTACH:<br />&nbsp;&nbsp;break;<br />&nbsp;case DLL_THREAD_DETACH:<br />&nbsp;&nbsp;break;<br />&nbsp;}<br />&nbsp;return TRUE;<br />}<br /></p></div></table><br><div class=opt id=blogOpt><a href="http://hi.baidu.com/175943462/blog/category/qq%CF%D4ip" title="查看该分类中所有文章">类别：qq显ip</a><span class=x-blog-opt-sp>|</span><a href="#" onclick="addToShare(); return false;" target=_blank><img src=http://img.baidu.com/hi/apps/share/share_btn.gif border=0 align=absbottom></a><span class=x-blog-opt-sp>|</span><a title="将此文章添加到百度搜藏" href=http://cang.baidu.com/do/add onClick="return addToFavor();" target=_blank>添加到搜藏</a> <span class=x-blog-opt-sp>|</span><a title="将此文章分享到i贴吧" href="#" onclick="addToiTieba(); return false;" target=_blank>分享到i贴吧</a><span class=x-blog-opt-sp>|</span>浏览(<span id=result>314</span>)<span class=x-blog-opt-sp>|</span><a href="#send">评论</a>&nbsp;(<span id=blogCmtCount>0</span>)<script language=javascript>
										/*<![CDATA[*/
										var pre = [true,'显示对方的QQip', '显示对方的QQip','\/175943462/blog/item/ee7b14d259c6a0c0a8ec9aca.html'];
										var post = [true,'我的QQ显IP','我的QQ显IP', '\/175943462/blog/item/715849501fb689af8d543049.html'];
										if(pre[0] || post[0]){
											document.write('<div style="height:5px;line-height:5px;">&nbsp;</div><div id="in_nav">');
											if(pre[0]){
												document.write('上一篇：<a href="' + pre[3] + '" title="' + pre[1] + '">' +  pre[2] + '</a>&nbsp;&nbsp;&nbsp;&nbsp;');
											}
											if(post[0]){
												document.write('下一篇：<a href="' + post[3] + '" title="' + post[1] + '">' +  post[2] + '</a>');
											}
											document.write('</div>');
										}
										/*]]>*/
									</script></div><div class=line>&nbsp;</div><div id=share_user_list></div><div class=line>&nbsp;</div><style type="text/css">#in_related_doc a{text-decoration:none}</style><div id=in_related_tmp></div><div id=in_reader> <div class=tit>最近读者：</div></div><div class=line>&nbsp;</div><div id=in_comment> <a name=comment></a> <div class=tit>网友评论：</div> <span id=userCommentList></span> <div id=page></div></div><form action='/175943462/commit' id=blogCmtSubmitForm name=blogCmtSubmitForm method=post> <input type=hidden name=bdstoken value='the fisrt two args should be string type:0,1!'> <input type=hidden name=ct value=8> <input type=hidden name=cm value=2> <input type=hidden name=spBlogID value='2b4d281a8026f4daaf513390'> <input type=hidden name=spBlogCmtID value=''> <input type=hidden name=spRefURL value=''></form><div id=in_send><a name=send></a><form name=form1 id=popFormSubmit action="/175943462/commit" method=post onSubmit="return checkcmtform()"><input type=hidden name=bdstoken value="the fisrt two args should be string type:0,1!"><input type=hidden name=ct value=8><input type=hidden name=cm value=1><input type=hidden name=spBlogID value="2b4d281a8026f4daaf513390"><input type=hidden name=spRefURL id=spRefURL><script>
										    document.getElementById("spRefURL").value = window.location.href;
										</script><div class=tit>发表评论：</div><table width=620 border=0 cellspacing=5 cellpadding=0><tr><td class=f14>姓　名：<td><input name=spBlogCmtor id=spBlogCmtor style=width:220px tabindex=1 onChange="checkname('spBlogCmtor')" maxlength=49 onFocus="hidErr(1);"><script>
                                                            document.write(" &nbsp;&nbsp; <a href='http://hi.baidu.com/st/reg.html' target='_blank'>注册</a>");
                                                            document.write(' | <a href="https://passport.baidu.com/?login&tpl=sp&tpl_reg=sp&u='+myref+'" onclick="BdUtil.relogin(); return false;">登录</a>');
														</script><div style=display:none id=nmerror>*姓名最长为50字节</div><tr id=1_err style=display:none><td>&nbsp;<td><div class=error id=1_err_con></div><tr><td class=f14>网址或邮箱：<td><input name=spBlogCmtURL id=spBlogCmtURL style=width:360px maxlength=128 tabindex=2 onChange="checkeandu('spBlogCmtURL')" onFocus="hidErr(2);"> (选填)<script>
														G("spBlogCmtor").value="";
														G("spBlogCmtURL").value="";
													</script><tr id=2_err style=display:none><td>&nbsp;<td><div class=error id=2_err_con></div><tr><td valign=top class=f14 id=reTitle>内　容：<td><textarea name="spBlogCmtText" id="spBlogCmtText" style="width:520px;height:155px"  tabindex="3" onFocus="hidErr(3);" onclick="BdUtil.relogin(); return false;" ></textarea><tr id=3_err style=display:none><td>&nbsp;<td><div class=error id=3_err_con></div><tr><td valign=top class=f14>&nbsp;<td valign=top class=f14><input id=btn_ok name=btn_ok type=submit autocomplete=off onclick="BdUtil.relogin(); return false;" value="发表评论" tabindex=5>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" id=cancleReLink onClick="canclereply(); return false;" style="display:none; font-size:12px;color:#666;">取消回复</a></table></form></div><br></div><table width="100%" border=0 cellspacing=0 cellpadding=0 height=8><tr><td class=modbl width=7>&nbsp;<td class=modbc>&nbsp;<td class=modbr width=7>&nbsp;</table></div></div></div></div><div class=clearfix></div><div style="text-align:center;margin:30px auto 15px;font-family:Arial,simsun;font-size:12px;"><div style="margin:0 auto 6px;"><a href=http://help.baidu.com/question?prod_en=space target=_blank style="color:#00C;">帮助中心</a><span>&nbsp;|&nbsp;</span><a href="http://tieba.baidu.com/f?kw=%B0%D9%B6%C8%BF%D5%BC%E4&fr=wwwt" target=_blank style="color:#00C;">空间客服</a><span>&nbsp;|&nbsp;</span><a href=http://tousu.baidu.com/hi/ target=_blank style="color:#00C;">投诉中心</a><span>&nbsp;|&nbsp;</span><a href=http://www.baidu.com/search/hi_contract.html target=_blank style="color:#00C;">空间协议</a></div><div style="color:#7A77C8;">&copy;2012&nbsp;Baidu</div></div></center><ul id=blogCmtContentList style="display:none;"></ul><script>	var g_blogTitle = 'QQ显IP代码';
		var g_blogId = '2b4d281a8026f4daaf513390';
		var g_isAllowCmt =  true ;
		var g_isByShared =  true ;
		var g_isAddRelate =  true ;
		var g_latestReader = [
									["http:\/\/hi.baidu.com\/linc_lee","6e376c696e635f6c65659e0e","linc_lee"],
									["http:\/\/hi.baidu.com\/digexploit","675e4469674578706c6f69748e04","DigExploit"],
									["http:\/\/hi.baidu.com\/tymylover","9e0374796d796c6f7665727402","tymylover"],
									["http:\/\/hi.baidu.com\/123553628","82db3132333535333632387502","123553628"],
									["http:\/\/hi.baidu.com\/pjz969","44a0706a7a3936392b0d","pjz969"],
									["http:\/\/hi.baidu.com\/1984danger","bad63139383464616e6765721708","1984danger"],
									["http:\/\/hi.baidu.com\/zh7658","64757a68373635385e02","zh7658"],
									["http:\/\/hi.baidu.com\/hacker_hen","78e66861636b65725f68656e340a","hacker_hen"],
								{}
			];
	</script><iframe id=submitiframe name=submitiframe src="http://hi.bdimg.com/static/cblog/html/blank.html?v=20111213" style="display:none;"></iframe><script src="http://hi.bdimg.com/static/base/js/conf/comment.js?v=1334907755.js"></script><script src="http://hi.bdimg.com/static/cblog/js/job/detailpage.js?v=ee7931cf.js"></script><script>
/*<![CDATA[*/
/*{cmt
    这个相当一个代理器  
  在这里想实现一种这种加载效果：加载时注册（用一个 初始化数据.数组 记录要绑定的ID），文档ready后，按需加载js+css资源，js加载完，就初始化据执行

  有个问题，有些结构是 动态 执行这个绑定的，可能会发生资源还没有加载的情况。可以考虑给初始化数据，加一个标志位，说明加载完未，如果未，则把数据push到 初始化数据中(因为是用 dom.onxxx 的方式，所以不怕多次对同一个ID执行的问题)


  }*/
var SP = SP || {};
if(!SP.mycard){
    SP.mycard = new (function(){
        var me = this;
        var _cancleAction = Session.isDrag;  /*{cmt 标记在特殊情况下，所有的注册都被abort 如拖动页面}*/
        var _list = [];
        var _sourceLoaded = false;    /*{cmt 这里用了一种资源加载结束后，回调的机制，这个标志资源是否加载结束}*/
        me.bind = function (_id){
            if(_cancleAction){  //abort
                return;
            }
            if(!_sourceLoaded){
                _list.push(_id);
            } else {
                baidu.space.mycard.bind(_id);
            }
        }
        me.init = function (_config){
            _cancleAction = !!_config.cancle;
        }
        me.onSourceLoaded = function (){
            _sourceLoaded = true;
            baidu.space.mycard.init({portrait: Session.visitorPortrait});
            for(var i=0,len=_list.length; i<len; i++){
                baidu.space.mycard.bind(_list[i]);
            }
        }
    })();
    baidu.dom.ready(function(){
        BdAjax.loadCSS('http://hi.bdimg.com/static/cblog/css/ui/ucard/ucard.css?v=50de96ca.css');
        BdAjax.loadJS('http://hi.bdimg.com/static/cblog/js/ui/ucard/ucard.js?v=fcbffbf8.js');
    });
}
SP.mycard.bind('m_blog');  /*{cmt 只有文档加载完才真正绑定，这里只是append记录 }*/
/*]]>*/
</script>